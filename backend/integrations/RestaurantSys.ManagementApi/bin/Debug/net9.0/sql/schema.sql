-- ===== Core =====
SET search_path = public;
CREATE EXTENSION IF NOT EXISTS pgcrypto;  -- for gen_random_uuid()

-- ===== Tables =====
CREATE TABLE IF NOT EXISTS menus (
  menu_num   INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name       TEXT NOT NULL CHECK (length(btrim(name)) > 0),
  created_at timestamptz NOT NULL DEFAULT now()
);

CREATE TABLE IF NOT EXISTS menu_nodes (
  node_id     uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  parent_id   uuid NULL REFERENCES menu_nodes(node_id) ON DELETE CASCADE,
  name        TEXT NOT NULL CHECK (length(btrim(name)) > 0),
  is_leaf     boolean NOT NULL,
  price_cents int,
  sort_order  int NOT NULL DEFAULT 0,
  layer       int NOT NULL DEFAULT 0,          -- 0 = root
  menu_num    integer NOT NULL REFERENCES menus(menu_num),
  created_at  timestamptz NOT NULL DEFAULT now()
);

-- One root per menu
CREATE UNIQUE INDEX IF NOT EXISTS ux_menu_root_one_per_menu
  ON menu_nodes(menu_num)
  WHERE layer = 0 AND parent_id IS NULL;

CREATE INDEX IF NOT EXISTS ix_menu_nodes_parent      ON menu_nodes(parent_id);
CREATE INDEX IF NOT EXISTS ix_menu_nodes_menu        ON menu_nodes(menu_num);
CREATE INDEX IF NOT EXISTS ix_menu_nodes_parent_sort ON menu_nodes(parent_id, sort_order);
CREATE INDEX IF NOT EXISTS ix_menu_nodes_is_leaf     ON menu_nodes(is_leaf);

-- ===== Triggers & functions =====

-- Default/validate menu name:
-- - INSERT: if name is NULL/blank => 'Menu <menu_num>'
-- - UPDATE: forbid blank
CREATE OR REPLACE FUNCTION set_menu_defaults()
RETURNS trigger AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    IF NEW.name IS NULL OR length(btrim(NEW.name)) = 0 THEN
      NEW.name := 'Menu ' || NEW.menu_num;
    END IF;
    RETURN NEW;
  ELSE
    IF NEW.name IS NULL OR length(btrim(NEW.name)) = 0 THEN
      RAISE EXCEPTION 'menus.name cannot be blank';
    END IF;
    RETURN NEW;
  END IF;
END
$$ LANGUAGE plpgsql;

DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'trg_set_menu_defaults') THEN
    CREATE TRIGGER trg_set_menu_defaults
      BEFORE INSERT OR UPDATE ON menus
      FOR EACH ROW
      EXECUTE FUNCTION set_menu_defaults();
  END IF;
END
$$;

-- After creating a menu, auto-create its root node (layer 0, parent NULL, same name)
CREATE OR REPLACE FUNCTION create_menu_root_after_insert()
RETURNS trigger AS $$
BEGIN
  BEGIN
    INSERT INTO menu_nodes (parent_id, name, is_leaf, price_cents, sort_order, layer, menu_num)
    VALUES (NULL, NEW.name, FALSE, NULL, 0, 0, NEW.menu_num);
  EXCEPTION WHEN unique_violation THEN
    -- Root already exists, ignore
    NULL;
  END;
  RETURN NEW;
END
$$ LANGUAGE plpgsql;

DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'trg_create_menu_root_after_insert') THEN
    CREATE TRIGGER trg_create_menu_root_after_insert
      AFTER INSERT ON menus
      FOR EACH ROW
      EXECUTE FUNCTION create_menu_root_after_insert();
  END IF;
END
$$;

-- ===== (Optional) quick checks =====
-- -- expect 'AAA' + root:
-- -- INSERT INTO menus(name) VALUES ('AAA');
-- -- expect 'Menu <n>' + root:
-- -- INSERT INTO menus(name) VALUES (NULL);
-- -- SELECT * FROM menus ORDER BY menu_num;
-- -- SELECT menu_num, name, layer, parent_id FROM menu_nodes WHERE layer=0 ORDER BY menu_num;
